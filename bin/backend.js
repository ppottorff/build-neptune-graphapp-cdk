#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const cdk = require("aws-cdk-lib");
const neptune_network_stack_1 = require("../lib/neptune-network-stack");
const api_stack_1 = require("../lib/api-stack");
const waf_stack_1 = require("../lib/waf-stack");
const cdk_nag_1 = require("cdk-nag");
const config_1 = require("../config");
const NagLogger_1 = require("../nag/NagLogger");
const app = new cdk.App();
const logger = new NagLogger_1.NagLogger();
cdk.Aspects.of(app).add(new cdk_nag_1.AwsSolutionsChecks({ verbose: true, additionalLoggers: [logger] }));
const appName = config_1.deployConfig.appName || "graphApp";
const env = {
    account: process.env.CDK_DEFAULT_ACCOUNT || process.env.AWS_ACCOUNT_ID,
    region: config_1.deployConfig.region || process.env.CDK_DEFAULT_REGION,
};
const neptuneNetwork = new neptune_network_stack_1.NeptuneNetworkStack(app, `${appName}-NeptuneNetworkStack`, {
    natSubnet: false,
    maxAz: 2,
    neptuneServerlss: true,
    neptuneServerlssCapacity: {
        minCapacity: 1,
        maxCapacity: 2.5,
    },
    // Stop Neptune 12am–4pm Pacific to save costs
    neptuneSchedule: {
        enabled: true,
        timezone: "America/Los_Angeles",
        stopHour: 0, // midnight Pacific — cluster stops
        startHour: 16, // 4pm Pacific — cluster starts
    },
    env,
});
new api_stack_1.ApiStack(app, `${appName}-ApiStack`, {
    cognito: {
        adminEmail: config_1.deployConfig.adminEmail,
    },
    vpc: neptuneNetwork.vpc,
    cluster: neptuneNetwork.cluster,
    clusterRole: neptuneNetwork.neptuneRole,
    graphqlFieldName: ["getGraph", "getProfile", "getRelationName", "insertData"],
    s3Uri: config_1.deployConfig.s3Uri,
    env,
});
new waf_stack_1.WafCloudFrontStack(app, `${appName}-WafStack`, {
    allowedIps: config_1.deployConfig.allowedIps,
    wafParamName: config_1.deployConfig.wafParamName,
    env: {
        ...env,
        region: "us-east-1",
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJhY2tlbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsdUNBQXFDO0FBQ3JDLG1DQUFtQztBQUNuQyx3RUFBbUU7QUFDbkUsZ0RBQTRDO0FBQzVDLGdEQUFzRDtBQUN0RCxxQ0FBNkM7QUFFN0Msc0NBQXlDO0FBQ3pDLGdEQUE2QztBQUU3QyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFTLEVBQUUsQ0FBQztBQUUvQixHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQ3JCLElBQUksNEJBQWtCLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUN2RSxDQUFDO0FBRUYsTUFBTSxPQUFPLEdBQUcscUJBQVksQ0FBQyxPQUFPLElBQUksVUFBVSxDQUFDO0FBQ25ELE1BQU0sR0FBRyxHQUFHO0lBQ1YsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO0lBQ3RFLE1BQU0sRUFBRSxxQkFBWSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQjtDQUM5RCxDQUFDO0FBQ0YsTUFBTSxjQUFjLEdBQUcsSUFBSSwyQ0FBbUIsQ0FDNUMsR0FBRyxFQUNILEdBQUcsT0FBTyxzQkFBc0IsRUFDaEM7SUFDRSxTQUFTLEVBQUUsS0FBSztJQUNoQixLQUFLLEVBQUUsQ0FBQztJQUNSLGdCQUFnQixFQUFFLElBQUk7SUFDdEIsd0JBQXdCLEVBQUU7UUFDeEIsV0FBVyxFQUFFLENBQUM7UUFDZCxXQUFXLEVBQUUsR0FBRztLQUNqQjtJQUNELDhDQUE4QztJQUM5QyxlQUFlLEVBQUU7UUFDZixPQUFPLEVBQUUsSUFBSTtRQUNiLFFBQVEsRUFBRSxxQkFBcUI7UUFDL0IsUUFBUSxFQUFFLENBQUMsRUFBSSxtQ0FBbUM7UUFDbEQsU0FBUyxFQUFFLEVBQUUsRUFBRywrQkFBK0I7S0FDaEQ7SUFDRCxHQUFHO0NBQ0osQ0FDRixDQUFDO0FBRUYsSUFBSSxvQkFBUSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sV0FBVyxFQUFFO0lBQ3ZDLE9BQU8sRUFBRTtRQUNQLFVBQVUsRUFBRSxxQkFBWSxDQUFDLFVBQVU7S0FDcEM7SUFDRCxHQUFHLEVBQUUsY0FBYyxDQUFDLEdBQUc7SUFDdkIsT0FBTyxFQUFFLGNBQWMsQ0FBQyxPQUFPO0lBQy9CLFdBQVcsRUFBRSxjQUFjLENBQUMsV0FBVztJQUN2QyxnQkFBZ0IsRUFBRSxDQUFDLFVBQVUsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxDQUFDO0lBQzdFLEtBQUssRUFBRSxxQkFBWSxDQUFDLEtBQUs7SUFDekIsR0FBRztDQUNKLENBQUMsQ0FBQztBQUVILElBQUksOEJBQWtCLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxXQUFXLEVBQUU7SUFDakQsVUFBVSxFQUFFLHFCQUFZLENBQUMsVUFBVTtJQUNuQyxZQUFZLEVBQUUscUJBQVksQ0FBQyxZQUFZO0lBQ3ZDLEdBQUcsRUFBRTtRQUNILEdBQUcsR0FBRztRQUNOLE1BQU0sRUFBRSxXQUFXO0tBQ3BCO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuaW1wb3J0IFwic291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBOZXB0dW5lTmV0d29ya1N0YWNrIH0gZnJvbSBcIi4uL2xpYi9uZXB0dW5lLW5ldHdvcmstc3RhY2tcIjtcbmltcG9ydCB7IEFwaVN0YWNrIH0gZnJvbSBcIi4uL2xpYi9hcGktc3RhY2tcIjtcbmltcG9ydCB7IFdhZkNsb3VkRnJvbnRTdGFjayB9IGZyb20gXCIuLi9saWIvd2FmLXN0YWNrXCI7XG5pbXBvcnQgeyBBd3NTb2x1dGlvbnNDaGVja3MgfSBmcm9tIFwiY2RrLW5hZ1wiO1xuXG5pbXBvcnQgeyBkZXBsb3lDb25maWcgfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQgeyBOYWdMb2dnZXIgfSBmcm9tIFwiLi4vbmFnL05hZ0xvZ2dlclwiO1xuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuY29uc3QgbG9nZ2VyID0gbmV3IE5hZ0xvZ2dlcigpO1xuXG5jZGsuQXNwZWN0cy5vZihhcHApLmFkZChcbiAgbmV3IEF3c1NvbHV0aW9uc0NoZWNrcyh7IHZlcmJvc2U6IHRydWUsIGFkZGl0aW9uYWxMb2dnZXJzOiBbbG9nZ2VyXSB9KVxuKTtcblxuY29uc3QgYXBwTmFtZSA9IGRlcGxveUNvbmZpZy5hcHBOYW1lIHx8IFwiZ3JhcGhBcHBcIjtcbmNvbnN0IGVudiA9IHtcbiAgYWNjb3VudDogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfQUNDT1VOVCB8fCBwcm9jZXNzLmVudi5BV1NfQUNDT1VOVF9JRCxcbiAgcmVnaW9uOiBkZXBsb3lDb25maWcucmVnaW9uIHx8IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX1JFR0lPTixcbn07XG5jb25zdCBuZXB0dW5lTmV0d29yayA9IG5ldyBOZXB0dW5lTmV0d29ya1N0YWNrKFxuICBhcHAsXG4gIGAke2FwcE5hbWV9LU5lcHR1bmVOZXR3b3JrU3RhY2tgLFxuICB7XG4gICAgbmF0U3VibmV0OiBmYWxzZSxcbiAgICBtYXhBejogMixcbiAgICBuZXB0dW5lU2VydmVybHNzOiB0cnVlLFxuICAgIG5lcHR1bmVTZXJ2ZXJsc3NDYXBhY2l0eToge1xuICAgICAgbWluQ2FwYWNpdHk6IDEsXG4gICAgICBtYXhDYXBhY2l0eTogMi41LFxuICAgIH0sXG4gICAgLy8gU3RvcCBOZXB0dW5lIDEyYW3igJM0cG0gUGFjaWZpYyB0byBzYXZlIGNvc3RzXG4gICAgbmVwdHVuZVNjaGVkdWxlOiB7XG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgdGltZXpvbmU6IFwiQW1lcmljYS9Mb3NfQW5nZWxlc1wiLFxuICAgICAgc3RvcEhvdXI6IDAsICAgLy8gbWlkbmlnaHQgUGFjaWZpYyDigJQgY2x1c3RlciBzdG9wc1xuICAgICAgc3RhcnRIb3VyOiAxNiwgIC8vIDRwbSBQYWNpZmljIOKAlCBjbHVzdGVyIHN0YXJ0c1xuICAgIH0sXG4gICAgZW52LFxuICB9XG4pO1xuXG5uZXcgQXBpU3RhY2soYXBwLCBgJHthcHBOYW1lfS1BcGlTdGFja2AsIHtcbiAgY29nbml0bzoge1xuICAgIGFkbWluRW1haWw6IGRlcGxveUNvbmZpZy5hZG1pbkVtYWlsLFxuICB9LFxuICB2cGM6IG5lcHR1bmVOZXR3b3JrLnZwYyxcbiAgY2x1c3RlcjogbmVwdHVuZU5ldHdvcmsuY2x1c3RlcixcbiAgY2x1c3RlclJvbGU6IG5lcHR1bmVOZXR3b3JrLm5lcHR1bmVSb2xlLFxuICBncmFwaHFsRmllbGROYW1lOiBbXCJnZXRHcmFwaFwiLCBcImdldFByb2ZpbGVcIiwgXCJnZXRSZWxhdGlvbk5hbWVcIiwgXCJpbnNlcnREYXRhXCJdLFxuICBzM1VyaTogZGVwbG95Q29uZmlnLnMzVXJpLFxuICBlbnYsXG59KTtcblxubmV3IFdhZkNsb3VkRnJvbnRTdGFjayhhcHAsIGAke2FwcE5hbWV9LVdhZlN0YWNrYCwge1xuICBhbGxvd2VkSXBzOiBkZXBsb3lDb25maWcuYWxsb3dlZElwcyxcbiAgd2FmUGFyYW1OYW1lOiBkZXBsb3lDb25maWcud2FmUGFyYW1OYW1lLFxuICBlbnY6IHtcbiAgICAuLi5lbnYsXG4gICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICB9LFxufSk7XG4iXX0=