"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const signature_v4_1 = require("@smithy/signature-v4");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const sha256_js_1 = require("@aws-crypto/sha256-js");
const protocol_http_1 = require("@smithy/protocol-http");
const signer = new signature_v4_1.SignatureV4({
    region: "us-east-1",
    service: "neptune-db",
    sha256: sha256_js_1.Sha256,
    credentials: (0, credential_provider_node_1.defaultProvider)(),
});
const vertexUri = process.env.VERTEX;
const edgeUri = process.env.EDGE;
const iamRoleArn = process.env.ROLE_ARN;
const url = `${process.env.NEPTUNE_ENDPOINT}:${process.env.NEPTUNE_PORT}`;
exports.handler = awslambda.streamifyResponse(async (event, responseStream) => {
    try {
        console.log(JSON.stringify(event.body));
        console.log("Start streaming response");
        responseStream.write("Start streaming response\n");
        for await (const source of [vertexUri, edgeUri]) {
            const input = {
                source,
                format: "csv",
                iamRoleArn,
                region: "us-east-1",
                failOnError: "FALSE",
                parallelism: "MEDIUM",
                updateSingleCardinalityProperties: "FALSE",
                queueRequest: "TRUE",
            };
            responseStream.write(`Start bulk load of ${source}\n`);
            const req = await signer.sign(new protocol_http_1.HttpRequest({
                method: "POST",
                protocol: "https:",
                path: "/loader",
                hostname: url,
                headers: {
                    "Content-Type": "application/json",
                    host: url,
                },
                body: JSON.stringify(input),
            }));
            const res = await fetch(`${req.protocol}${req.hostname}${req.path}`, {
                method: req.method,
                body: req.body,
                headers: req.headers,
            });
            const response = await res.json();
            console.log(response);
            const loadId = response.payload.loadId;
            const loadCheckReq = await signer.sign(new protocol_http_1.HttpRequest({
                method: "GET",
                protocol: "https:",
                path: `/loader/${loadId}`,
                hostname: url,
                headers: {
                    "Content-Type": "application/json",
                    host: url,
                },
            }));
            let status = "";
            responseStream.write(`Load status checking of ${source}\n`);
            responseStream.write("Waiting for load status change ....");
            while (status !== "LOAD_COMPLETED") {
                const loadRes = await fetch(`${loadCheckReq.protocol}${loadCheckReq.hostname}${loadCheckReq.path}`, {
                    method: loadCheckReq.method,
                    body: loadCheckReq.body,
                    headers: loadCheckReq.headers,
                });
                const loadStatus = await loadRes.json();
                console.log(loadStatus);
                responseStream.write("....");
                status = loadStatus.payload.overallStatus.status;
            }
            responseStream.write("\n");
            responseStream.write("Load completed\n");
            responseStream.write(response.status);
            responseStream.write("\n");
        }
    }
    catch (error) {
        console.log({ error });
        responseStream.write(`ERROR: ${error}`);
        responseStream.end();
    }
    responseStream.write("End streaming response");
    responseStream.end();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSx1REFBbUQ7QUFDbkQsZ0ZBQW9FO0FBQ3BFLHFEQUErQztBQUMvQyx5REFBb0Q7QUFnQnBELE1BQU0sTUFBTSxHQUFHLElBQUksMEJBQVcsQ0FBQztJQUM3QixNQUFNLEVBQUUsV0FBVztJQUNuQixPQUFPLEVBQUUsWUFBWTtJQUNyQixNQUFNLEVBQUUsa0JBQU07SUFDZCxXQUFXLEVBQUUsSUFBQSwwQ0FBZSxHQUFFO0NBQy9CLENBQUMsQ0FBQztBQUNILE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTyxDQUFDO0FBQ3RDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSyxDQUFDO0FBQ2xDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO0FBQ3hDLE1BQU0sR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0FBQzdELFFBQUEsT0FBTyxHQUFZLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDekQsS0FBSyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsRUFBRTtJQUM5QixJQUFJLENBQUM7UUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ3hDLGNBQWMsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztRQUNuRCxJQUFJLEtBQUssRUFBRSxNQUFNLE1BQU0sSUFBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2hELE1BQU0sS0FBSyxHQUFHO2dCQUNaLE1BQU07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TUFBTSxDQUFDLENBQUM7WUFDdEMsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixDQUFDO0lBQ0gsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDdkIsY0FBYyxDQUFDLEtBQUssQ0FBQyxVQUFVLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDeEMsY0FBYyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxjQUFjLENBQUMsS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDL0MsY0FBYyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLENBQUMsQ0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSGFuZGxlciB9IGZyb20gXCJhd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBTaWduYXR1cmVWNCB9IGZyb20gXCJAc21pdGh5L3NpZ25hdHVyZS12NFwiO1xuaW1wb3J0IHsgZGVmYXVsdFByb3ZpZGVyIH0gZnJvbSBcIkBhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItbm9kZVwiO1xuaW1wb3J0IHsgU2hhMjU2IH0gZnJvbSBcIkBhd3MtY3J5cHRvL3NoYTI1Ni1qc1wiO1xuaW1wb3J0IHsgSHR0cFJlcXVlc3QgfSBmcm9tIFwiQHNtaXRoeS9wcm90b2NvbC1odHRwXCI7XG5kZWNsYXJlIGdsb2JhbCB7XG4gIG5hbWVzcGFjZSBhd3NsYW1iZGEge1xuICAgIGZ1bmN0aW9uIHN0cmVhbWlmeVJlc3BvbnNlKFxuICAgICAgZjogKGV2ZW50OiBhbnksIHJlc3BvbnNlU3RyZWFtOiBOb2RlSlMuV3JpdGFibGVTdHJlYW0pID0+IFByb21pc2U8dm9pZD5cbiAgICApOiBIYW5kbGVyO1xuICB9XG59XG5cbnR5cGUgUGF5bG9hZCA9IHtcbiAgbG9hZElkOiBzdHJpbmc7XG59O1xudHlwZSBCdWxrTG9hZFJlc3BvbnNlID0ge1xuICBzdGF0dXM6IHN0cmluZztcbiAgcGF5bG9hZDogUGF5bG9hZDtcbn07XG5jb25zdCBzaWduZXIgPSBuZXcgU2lnbmF0dXJlVjQoe1xuICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gIHNlcnZpY2U6IFwibmVwdHVuZS1kYlwiLFxuICBzaGEyNTY6IFNoYTI1NixcbiAgY3JlZGVudGlhbHM6IGRlZmF1bHRQcm92aWRlcigpLFxufSk7XG5jb25zdCB2ZXJ0ZXhVcmkgPSBwcm9jZXNzLmVudi5WRVJURVghO1xuY29uc3QgZWRnZVVyaSA9IHByb2Nlc3MuZW52LkVER0UhO1xuY29uc3QgaWFtUm9sZUFybiA9IHByb2Nlc3MuZW52LlJPTEVfQVJOO1xuY29uc3QgdXJsID0gYCR7cHJvY2Vzcy5lbnYuTkVQVFVORV9FTkRQT0lOVH06JHtwcm9jZXNzLmVudi5ORVBUVU5FX1BPUlR9YDtcbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyID0gYXdzbGFtYmRhLnN0cmVhbWlmeVJlc3BvbnNlKFxuICBhc3luYyAoZXZlbnQsIHJlc3BvbnNlU3RyZWFtKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGV2ZW50LmJvZHkpKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiU3RhcnQgc3RyZWFtaW5nIHJlc3BvbnNlXCIpO1xuICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUoXCJTdGFydCBzdHJlYW1pbmcgcmVzcG9uc2VcXG5cIik7XG4gICAgICBmb3IgYXdhaXQgKGNvbnN0IHNvdXJjZSBvZiBbdmVydGV4VXJpLCBlZGdlVXJpXSkge1xuICAgICAgICBjb25zdCBpbnB1dCA9IHtcbiAgICAgICAgICBzb3VyY2UsXG4gICAgICAgICAgZm9ybWF0OiBcImNzdlwiLFxuICAgICAgICAgIGlhbVJvbGVBcm4sXG4gICAgICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgICAgICAgIGZhaWxPbkVycm9yOiBcIkZBTFNFXCIsXG4gICAgICAgICAgcGFyYWxsZWxpc206IFwiTUVESVVNXCIsXG4gICAgICAgICAgdXBkYXRlU2luZ2xlQ2FyZGluYWxpdHlQcm9wZXJ0aWVzOiBcIkZBTFNFXCIsXG4gICAgICAgICAgcXVldWVSZXF1ZXN0OiBcIlRSVUVcIixcbiAgICAgICAgfTtcbiAgICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUoYFN0YXJ0IGJ1bGsgbG9hZCBvZiAke3NvdXJjZX1cXG5gKTtcbiAgICAgICAgY29uc3QgcmVxID0gYXdhaXQgc2lnbmVyLnNpZ24oXG4gICAgICAgICAgbmV3IEh0dHBSZXF1ZXN0KHtcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICBwcm90b2NvbDogXCJodHRwczpcIixcbiAgICAgICAgICAgIHBhdGg6IFwiL2xvYWRlclwiLFxuICAgICAgICAgICAgaG9zdG5hbWU6IHVybCxcblxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgaG9zdDogdXJsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGlucHV0KSxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHtyZXEucHJvdG9jb2x9JHtyZXEuaG9zdG5hbWV9JHtyZXEucGF0aH1gLCB7XG4gICAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgICAgIGJvZHk6IHJlcS5ib2R5LFxuICAgICAgICAgIGhlYWRlcnM6IHJlcS5oZWFkZXJzLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2U6IEJ1bGtMb2FkUmVzcG9uc2UgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZSk7XG4gICAgICAgIGNvbnN0IGxvYWRJZCA9IHJlc3BvbnNlLnBheWxvYWQubG9hZElkO1xuXG4gICAgICAgIGNvbnN0IGxvYWRDaGVja1JlcSA9IGF3YWl0IHNpZ25lci5zaWduKFxuICAgICAgICAgIG5ldyBIdHRwUmVxdWVzdCh7XG4gICAgICAgICAgICBtZXRob2Q6IFwiR0VUXCIsXG4gICAgICAgICAgICBwcm90b2NvbDogXCJodHRwczpcIixcbiAgICAgICAgICAgIHBhdGg6IGAvbG9hZGVyLyR7bG9hZElkfWAsXG4gICAgICAgICAgICBob3N0bmFtZTogdXJsLFxuXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICBob3N0OiB1cmwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIGxldCBzdGF0dXM6IHN0cmluZyA9IFwiXCI7XG4gICAgICAgIHJlc3BvbnNlU3RyZWFtLndyaXRlKGBMb2FkIHN0YXR1cyBjaGVja2luZyBvZiAke3NvdXJjZX1cXG5gKTtcbiAgICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUoXCJXYWl0aW5nIGZvciBsb2FkIHN0YXR1cyBjaGFuZ2UgLi4uLlwiKTtcbiAgICAgICAgd2hpbGUgKHN0YXR1cyAhPT0gXCJMT0FEX0NPTVBMRVRFRFwiKSB7XG4gICAgICAgICAgY29uc3QgbG9hZFJlcyA9IGF3YWl0IGZldGNoKFxuICAgICAgICAgICAgYCR7bG9hZENoZWNrUmVxLnByb3RvY29sfSR7bG9hZENoZWNrUmVxLmhvc3RuYW1lfSR7bG9hZENoZWNrUmVxLnBhdGh9YCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbWV0aG9kOiBsb2FkQ2hlY2tSZXEubWV0aG9kLFxuICAgICAgICAgICAgICBib2R5OiBsb2FkQ2hlY2tSZXEuYm9keSxcbiAgICAgICAgICAgICAgaGVhZGVyczogbG9hZENoZWNrUmVxLmhlYWRlcnMsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBsb2FkU3RhdHVzID0gYXdhaXQgbG9hZFJlcy5qc29uKCk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZyhsb2FkU3RhdHVzKTtcblxuICAgICAgICAgIHJlc3BvbnNlU3RyZWFtLndyaXRlKFwiLi4uLlwiKTtcbiAgICAgICAgICBzdGF0dXMgPSBsb2FkU3RhdHVzLnBheWxvYWQub3ZlcmFsbFN0YXR1cy5zdGF0dXM7XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUoXCJcXG5cIik7XG4gICAgICAgIHJlc3BvbnNlU3RyZWFtLndyaXRlKFwiTG9hZCBjb21wbGV0ZWRcXG5cIik7XG5cbiAgICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUocmVzcG9uc2Uuc3RhdHVzKTtcbiAgICAgICAgcmVzcG9uc2VTdHJlYW0ud3JpdGUoXCJcXG5cIik7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5sb2coeyBlcnJvciB9KTtcbiAgICAgIHJlc3BvbnNlU3RyZWFtLndyaXRlKGBFUlJPUjogJHtlcnJvcn1gKTtcbiAgICAgIHJlc3BvbnNlU3RyZWFtLmVuZCgpO1xuICAgIH1cbiAgICByZXNwb25zZVN0cmVhbS53cml0ZShcIkVuZCBzdHJlYW1pbmcgcmVzcG9uc2VcIik7XG4gICAgcmVzcG9uc2VTdHJlYW0uZW5kKCk7XG4gIH1cbik7XG4iXX0=