"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const gremlin = require("gremlin");
const utils_1 = require("gremlin-aws-sigv4/lib/utils");
const DriverRemoteConnection = gremlin.driver.DriverRemoteConnection;
const traversal = gremlin.process.AnonymousTraversalSource.traversal;
const __ = gremlin.process.statics;
const handler = async (event) => {
    let conn = null;
    const getConnectionDetails = () => {
        return (0, utils_1.getUrlAndHeaders)(process.env.NEPTUNE_ENDPOINT, process.env.NEPTUNE_PORT, {}, "/gremlin", "wss");
    };
    const createRemoteConnection = () => {
        const { url, headers } = getConnectionDetails();
        console.log(url);
        console.log(headers);
        const c = new DriverRemoteConnection(url, {
            mimeType: "application/vnd.gremlin-v2.0+json",
            headers: headers,
        });
        c._client._connection.on("close", (code, message) => {
            console.info(`close - ${code} ${message}`);
            if (code == 1006) {
                console.error("Connection closed prematurely");
                throw new Error("Connection closed prematurely");
            }
        });
        return c;
    };
    let g;
    const id = gremlin.process.t.id;
    const { value, edge, vertex, source, sourceLabel, destination, destLabel, properties: propertiesJson, } = event.arguments.input;
    // Parse properties JSON (new generic approach)
    const props = propertiesJson ? JSON.parse(propertiesJson) : {};
    try {
        if (conn == null) {
            console.info("Initializing connection");
            conn = createRemoteConnection();
            g = traversal().withRemote(conn);
        }
        switch (value) {
            case "vertex": {
                // Generate a unique vertex ID using label prefix + timestamp
                const vertexId = `${vertex.toLowerCase()}_${Date.now()}`;
                // Start the addV traversal
                let t = g.addV(vertex).property(id, vertexId);
                // Add all properties from the properties JSON
                for (const [key, val] of Object.entries(props)) {
                    if (val !== undefined && val !== null && val !== "") {
                        t = t.property(key, val);
                    }
                }
                const result = await t.next();
                console.log("Created vertex:", vertexId, vertex, props);
                return { result: JSON.stringify(result) };
            }
            default: {
                // Edge creation
                console.log("Creating edge:", edge, "from", sourceLabel, source, "to", destLabel, destination);
                // Find source vertex by label and any name-like property
                let t = g
                    .V()
                    .hasLabel(sourceLabel)
                    .or(__.has("name", source), __.has("companyName", source), __.has("jobName", source), __.has("partName", source));
                // Add edge to destination vertex found by label and name-like property
                let edgeTraversal = t.addE(edge).to(__.V()
                    .hasLabel(destLabel)
                    .or(__.has("name", destination), __.has("companyName", destination), __.has("jobName", destination), __.has("partName", destination)));
                // Add edge properties from the properties JSON
                for (const [key, val] of Object.entries(props)) {
                    if (val !== undefined && val !== null && val !== "") {
                        edgeTraversal = edgeTraversal.property(key, val);
                    }
                }
                const res = await edgeTraversal.next();
                console.log("Created edge:", edge, props);
                return { result: JSON.stringify(res) };
            }
        }
    }
    catch (error) {
        console.log(error);
        console.error(JSON.stringify(error));
        const message = error instanceof Error ? error.message : String(error);
        return { error: message };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXV0YXRpb25HcmFwaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm11dGF0aW9uR3JhcGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsbUNBQW1DO0FBQ25DLHVEQUErRDtBQUUvRCxNQUFNLHNCQUFzQixHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUM7QUFDckUsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUM7QUFDckUsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFFNUIsTUFBTSxPQUFPLEdBQVksS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQzlDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztJQUNoQixNQUFNLG9CQUFvQixHQUFHLEdBQUcsRUFBRTtRQUNoQyxPQUFPLElBQUEsd0JBQWdCLEVBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUN4QixFQUFFLEVBQ0YsVUFBVSxFQUNWLEtBQUssQ0FDTixDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLEVBQUU7UUFDbEMsTUFBTSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxvQkFBb0IsRUFBRSxDQUFDO1FBRWhELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNyQixNQUFNLENBQUMsR0FBRyxJQUFJLHNCQUFzQixDQUFDLEdBQUcsRUFBRTtZQUN4QyxRQUFRLEVBQUUsbUNBQW1DO1lBQzdDLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUMsQ0FBQztRQUNILENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJ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QUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3pDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUFDLE9BQU8sS0FBYyxFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNyQyxNQUFNLE9BQU8sR0FBRyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUM1QixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBeEhXLFFBQUEsT0FBTyxXQXdIbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYW5kbGVyIH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcblxuaW1wb3J0ICogYXMgZ3JlbWxpbiBmcm9tIFwiZ3JlbWxpblwiO1xuaW1wb3J0IHsgZ2V0VXJsQW5kSGVhZGVycyB9IGZyb20gXCJncmVtbGluLWF3cy1zaWd2NC9saWIvdXRpbHNcIjtcblxuY29uc3QgRHJpdmVyUmVtb3RlQ29ubmVjdGlvbiA9IGdyZW1saW4uZHJpdmVyLkRyaXZlclJlbW90ZUNvbm5lY3Rpb247XG5jb25zdCB0cmF2ZXJzYWwgPSBncmVtbGluLnByb2Nlc3MuQW5vbnltb3VzVHJhdmVyc2FsU291cmNlLnRyYXZlcnNhbDtcbmNvbnN0IF9fID0gZ3JlbWxpbi5wcm9jZXNzLnN0YXRpY3M7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyID0gYXN5bmMgKGV2ZW50KSA9PiB7XG4gIGxldCBjb25uID0gbnVsbDtcbiAgY29uc3QgZ2V0Q29ubmVjdGlvbkRldGFpbHMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIGdldFVybEFuZEhlYWRlcnMoXG4gICAgICBwcm9jZXNzLmVudi5ORVBUVU5FX0VORFBPSU5ULFxuICAgICAgcHJvY2Vzcy5lbnYuTkVQVFVORV9QT1JULFxuICAgICAge30sXG4gICAgICBcIi9ncmVtbGluXCIsXG4gICAgICBcIndzc1wiXG4gICAgKTtcbiAgfTtcblxuICBjb25zdCBjcmVhdGVSZW1vdGVDb25uZWN0aW9uID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgdXJsLCBoZWFkZXJzIH0gPSBnZXRDb25uZWN0aW9uRGV0YWlscygpO1xuXG4gICAgY29uc29sZS5sb2codXJsKTtcbiAgICBjb25zb2xlLmxvZyhoZWFkZXJzKTtcbiAgICBjb25zdCBjID0gbmV3IERyaXZlclJlbW90ZUNvbm5lY3Rpb24odXJsLCB7XG4gICAgICBtaW1lVHlwZTogXCJhcHBsaWNhdGlvbi92bmQuZ3JlbWxpbi12Mi4wK2pzb25cIixcbiAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXG4gICAgfSk7XG4gICAgYy5fY2xpZW50Ll9jb25uZWN0aW9uLm9uKFwiY2xvc2VcIiwgKGNvZGU6IG51bWJlciwgbWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zb2xlLmluZm8oYGNsb3NlIC0gJHtjb2RlfSAke21lc3NhZ2V9YCk7XG4gICAgICBpZiAoY29kZSA9PSAxMDA2KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJDb25uZWN0aW9uIGNsb3NlZCBwcmVtYXR1cmVseVwiKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ29ubmVjdGlvbiBjbG9zZWQgcHJlbWF0dXJlbHlcIik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGM7XG4gIH07XG5cbiAgbGV0IGc7XG4gIGNvbnN0IGlkID0gZ3JlbWxpbi5wcm9jZXNzLnQuaWQ7XG4gIGNvbnN0IHtcbiAgICB2YWx1ZSxcbiAgICBlZGdlLFxuICAgIHZlcnRleCxcbiAgICBzb3VyY2UsXG4gICAgc291cmNlTGFiZWwsXG4gICAgZGVzdGluYXRpb24sXG4gICAgZGVzdExhYmVsLFxuICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXNKc29uLFxuICB9ID0gZXZlbnQuYXJndW1lbnRzLmlucHV0O1xuXG4gIC8vIFBhcnNlIHByb3BlcnRpZXMgSlNPTiAobmV3IGdlbmVyaWMgYXBwcm9hY2gpXG4gIGNvbnN0IHByb3BzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9XG4gICAgcHJvcGVydGllc0pzb24gPyBKU09OLnBhcnNlKHByb3BlcnRpZXNKc29uKSA6IHt9O1xuXG4gIHRyeSB7XG4gICAgaWYgKGNvbm4gPT0gbnVsbCkge1xuICAgICAgY29uc29sZS5pbmZvKFwiSW5pdGlhbGl6aW5nIGNvbm5lY3Rpb25cIik7XG4gICAgICBjb25uID0gY3JlYXRlUmVtb3RlQ29ubmVjdGlvbigpO1xuICAgICAgZyA9IHRyYXZlcnNhbCgpLndpdGhSZW1vdGUoY29ubik7XG4gICAgfVxuXG4gICAgc3dpdGNoICh2YWx1ZSkge1xuICAgICAgY2FzZSBcInZlcnRleFwiOiB7XG4gICAgICAgIC8vIEdlbmVyYXRlIGEgdW5pcXVlIHZlcnRleCBJRCB1c2luZyBsYWJlbCBwcmVmaXggKyB0aW1lc3RhbXBcbiAgICAgICAgY29uc3QgdmVydGV4SWQgPSBgJHt2ZXJ0ZXgudG9Mb3dlckNhc2UoKX1fJHtEYXRlLm5vdygpfWA7XG5cbiAgICAgICAgLy8gU3RhcnQgdGhlIGFkZFYgdHJhdmVyc2FsXG4gICAgICAgIGxldCB0ID0gZyEuYWRkVih2ZXJ0ZXgpLnByb3BlcnR5KGlkLCB2ZXJ0ZXhJZCk7XG5cbiAgICAgICAgLy8gQWRkIGFsbCBwcm9wZXJ0aWVzIGZyb20gdGhlIHByb3BlcnRpZXMgSlNPTlxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMpKSB7XG4gICAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IFwiXCIpIHtcbiAgICAgICAgICAgIHQgPSB0LnByb3BlcnR5KGtleSwgdmFsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0Lm5leHQoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJDcmVhdGVkIHZlcnRleDpcIiwgdmVydGV4SWQsIHZlcnRleCwgcHJvcHMpO1xuICAgICAgICByZXR1cm4geyByZXN1bHQ6IEpTT04uc3RyaW5naWZ5KHJlc3VsdCkgfTtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICAvLyBFZGdlIGNyZWF0aW9uXG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ3JlYXRpbmcgZWRnZTpcIiwgZWRnZSwgXCJmcm9tXCIsIHNvdXJjZUxhYmVsLCBzb3VyY2UsIFwidG9cIiwgZGVzdExhYmVsLCBkZXN0aW5hdGlvbik7XG5cbiAgICAgICAgLy8gRmluZCBzb3VyY2UgdmVydGV4IGJ5IGxhYmVsIGFuZCBhbnkgbmFtZS1saWtlIHByb3BlcnR5XG4gICAgICAgIGxldCB0ID0gZyFcbiAgICAgICAgICAuVigpXG4gICAgICAgICAgLmhhc0xhYmVsKHNvdXJjZUxhYmVsKVxuICAgICAgICAgIC5vcihcbiAgICAgICAgICAgIF9fLmhhcyhcIm5hbWVcIiwgc291cmNlKSxcbiAgICAgICAgICAgIF9fLmhhcyhcImNvbXBhbnlOYW1lXCIsIHNvdXJjZSksXG4gICAgICAgICAgICBfXy5oYXMoXCJqb2JOYW1lXCIsIHNvdXJjZSksXG4gICAgICAgICAgICBfXy5oYXMoXCJwYXJ0TmFtZVwiLCBzb3VyY2UpXG4gICAgICAgICAgKTtcblxuICAgICAgICAvLyBBZGQgZWRnZSB0byBkZXN0aW5hdGlvbiB2ZXJ0ZXggZm91bmQgYnkgbGFiZWwgYW5kIG5hbWUtbGlrZSBwcm9wZXJ0eVxuICAgICAgICBsZXQgZWRnZVRyYXZlcnNhbCA9IHQuYWRkRShlZGdlKS50byhcbiAgICAgICAgICBfXy5WKClcbiAgICAgICAgICAgIC5oYXNMYWJlbChkZXN0TGFiZWwpXG4gICAgICAgICAgICAub3IoXG4gICAgICAgICAgICAgIF9fLmhhcyhcIm5hbWVcIiwgZGVzdGluYXRpb24pLFxuICAgICAgICAgICAgICBfXy5oYXMoXCJjb21wYW55TmFtZVwiLCBkZXN0aW5hdGlvbiksXG4gICAgICAgICAgICAgIF9fLmhhcyhcImpvYk5hbWVcIiwgZGVzdGluYXRpb24pLFxuICAgICAgICAgICAgICBfXy5oYXMoXCJwYXJ0TmFtZVwiLCBkZXN0aW5hdGlvbilcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBBZGQgZWRnZSBwcm9wZXJ0aWVzIGZyb20gdGhlIHByb3BlcnRpZXMgSlNPTlxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMpKSB7XG4gICAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IFwiXCIpIHtcbiAgICAgICAgICAgIGVkZ2VUcmF2ZXJzYWwgPSBlZGdlVHJhdmVyc2FsLnByb3BlcnR5KGtleSwgdmFsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBlZGdlVHJhdmVyc2FsLm5leHQoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJDcmVhdGVkIGVkZ2U6XCIsIGVkZ2UsIHByb3BzKTtcbiAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiBKU09OLnN0cmluZ2lmeShyZXMpIH07XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcjogdW5rbm93bikge1xuICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICBjb25zb2xlLmVycm9yKEpTT04uc3RyaW5naWZ5KGVycm9yKSk7XG4gICAgY29uc3QgbWVzc2FnZSA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogbWVzc2FnZSB9O1xuICB9XG59O1xuIl19